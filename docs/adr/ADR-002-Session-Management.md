# ADR-002: Spring Session JDBCによるセッション管理の採用

## ステータス

採択 (2025-05-02)

## コンテキスト

ウェブアプリケーションでは、ユーザーセッションを適切に管理することが重要です。特に分散環境や複数のインスタンスがある場合、一貫したセッション管理が必須となります。以下の選択肢を検討しました：

1. **アプリケーションサーバーのメモリ内セッション**: サーバーメモリにセッションを保存
2. **Redis/Memcachedベースのセッション管理**: インメモリキャッシュにセッションを保存
3. **JDBCベースのセッション管理**: リレーショナルデータベースにセッションを保存
4. **完全にステートレスなアプローチ**: セッションを使用せず、JWTのみで認証状態を管理

## 決定

Spring Session JDBCを使用して、MySQLデータベースにセッション情報を保存する方式を採用することに決定しました。

## 理由

Spring Session JDBCを選択した主な理由：

1. **持続性**: データベースはセッションデータの信頼性の高い永続的なストレージを提供
2. **既存のインフラ活用**: すでにMySQLを使用しているため、追加のインフラ不要
3. **トランザクションの一貫性**: ユーザーデータとセッションデータを同じトランザクション内で管理可能
4. **スケーラビリティ**: 複数のアプリケーションインスタンスでセッションを共有可能
5. **セッション操作**: セッションの検索、監査、手動での管理が容易
6. **Spring Bootとの統合**: Spring Bootのオートコンフィグレーションにより、最小限の設定で実装可能

## 影響

この決定により、以下の影響があります：

### 肯定的な影響

1. **信頼性**: データベースの信頼性によるセッションデータの安全な保存
2. **スケーラビリティ**: 水平スケーリングに対応可能
3. **管理性**: セッションデータの監視と管理が容易
4. **一貫性**: 異なるサーバー間でのセッション状態の一貫性確保

### 懸念点

1. **パフォーマンス**: インメモリソリューションと比較して若干のレイテンシ増加
2. **ストレージ**: セッションデータによるデータベース容量の使用
3. **メンテナンス**: 期限切れセッションの定期的なクリーンアップの必要性

## 実装詳細

Spring Session JDBCの実装には以下の設定を行います：

1. `spring.session.store-type=jdbc` をapplication.propertiesに設定
2. `spring.session.jdbc.initialize-schema=always` で初回実行時にテーブル作成
3. `server.servlet.session.timeout=30m` でセッションタイムアウトを設定
4. HTTPセッションクッキーの設定（secure, http-only など）

## 代替案

検討した代替案：

1. **Redis**: 高速なアクセスが可能だが、追加のインフラ要件が発生
2. **インメモリセッション**: 最も単純だが、スケーリングが困難で信頼性に欠ける
3. **JWTのみ**: スケーラブルだが、無効化が難しくセキュリティリスクが増大

## 注意点

- セッションテーブルの定期的なクリーンアップ戦略の実装
- セッションデータのサイズ制限の検討
- パフォーマンスを監視し、必要に応じてRedisなどの高速なストレージへの移行を検討
- セッションテーブルのインデックス最適化の検討 